<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcula tu Ruta - Mapa Grande con Ventana Flotante</title>
<style>
  /* Reset y base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #eee;
    overflow: hidden;
  }

  /* Contenedor principal mapa ocupa todo */
  #map {
    width: 100vw;
    height: 100vh;
  }

  /* Ventana flotante info */
  #infoWindow {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 340px;
    max-height: 80vh;
    background-color: #1e1e1ecc; /* semitransparente */
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(250, 204, 21, 0.8);
    overflow-y: auto;
    color: #eee;
    z-index: 9999;
    user-select: text;
    display: flex;
    flex-direction: column;
  }

  #infoWindow h1 {
    margin: 0 0 12px 0;
    color: #facc15;
    font-size: 1.7rem;
    user-select: none;
  }

  #resultado {
    flex-grow: 1;
    font-size: 1.1rem;
    line-height: 1.4;
    margin-bottom: 15px;
  }

  #instrucciones {
    font-size: 0.95rem;
    line-height: 1.3;
    max-height: 250px;
    overflow-y: auto;
    margin-bottom: 15px;
  }

  /* Botón cerrar */
  #btn-close {
    align-self: flex-end;
    background-color: transparent;
    border: none;
    color: #facc15;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    margin-bottom: 10px;
    user-select: none;
    transition: color 0.3s ease;
  }
  #btn-close:hover {
    color: #eab308;
  }

  /* Botón limpiar */
  #btn-clear {
    background-color: #facc15;
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-weight: 700;
    color: #121212;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-bottom: 10px;
  }
  #btn-clear:hover {
    background-color: #eab308;
  }

  /* Botón buscar */
  #btn-buscar {
    background-color: #facc15;
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-weight: 700;
    color: #121212;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-bottom: 15px;
    width: 100%;
  }
  #btn-buscar:hover {
    background-color: #eab308;
  }

  /* Scrollbar personalizado para instrucciones */
  #instrucciones::-webkit-scrollbar {
    width: 6px;
  }
  #instrucciones::-webkit-scrollbar-thumb {
    background-color: #facc15aa;
    border-radius: 4px;
  }

  /* Responsive para móviles: info ventana más pequeña y abajo */
  @media (max-width: 600px) {
    #infoWindow {
      width: 95vw;
      max-height: 35vh;
      bottom: 20px;
      top: auto;
      right: 50%;
      transform: translateX(50%);
      border-radius: 10px;
      padding: 15px;
      font-size: 0.9rem;
    }
    #btn-close {
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
  

<div id="map" aria-label="Mapa con ruta"></div>

<!-- Ventana flotante con info -->
<aside id="infoWindow" role="complementary" aria-live="polite" aria-atomic="true">
  <!-- Inputs búsqueda -->
  <div style="margin-bottom: 15px;">
    <input id="search-origen" type="text" placeholder="Buscar lugar de origen" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; margin-bottom: 10px;" />
    <input id="search-destino" type="text" placeholder="Buscar lugar de destino" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem;" />
  </div>

  <!-- Botón buscar -->
  <button id="btn-buscar" aria-label="Buscar ruta">Buscar ruta</button>

  <button id="btn-close" aria-label="Cerrar ventana de información">&times;</button>
  <h1>Calcula tu ruta ✈️</h1>
  <div id="resultado">Haz clic en el mapa para elegir origen y destino.</div>
  <div id="instrucciones"></div>
  <button id="btn-clear">Limpiar mapa</button>
</aside>

<script>

  let map;
  let origen = null;
  let destino = null;
  let marcadores = [];
  let directionsService;
  let directionsRenderer;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 23.6345, lng: -102.5528 },
      zoom: 5,
      mapTypeControl: false,
      streetViewControl: false,
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      map,
      suppressMarkers: true,
    });

    // Inputs para autocomplete
    const inputOrigen = document.getElementById("search-origen");
    const inputDestino = document.getElementById("search-destino");

    const autocompleteOrigen = new google.maps.places.Autocomplete(inputOrigen, { fields: ["geometry", "name"] });
    const autocompleteDestino = new google.maps.places.Autocomplete(inputDestino, { fields: ["geometry", "name"] });

    autocompleteOrigen.addListener("place_changed", () => {
      const place = autocompleteOrigen.getPlace();
      if (!place.geometry || !place.geometry.location) {
        alert("No se encontró el lugar de origen.");
        return;
      }
      if (origen) {
        marcadores.find(m => m.label === "A")?.setMap(null);
        marcadores = marcadores.filter(m => m.label !== "A");
      }
      origen = place.geometry.location;
      const marcadorOrigen = new google.maps.Marker({
        position: origen,
        map,
        label: "A",
      });
      marcadores.push(marcadorOrigen);
      map.panTo(origen);

      if (origen && destino) {
        calcularRuta(origen, destino);
      }
    });

    autocompleteDestino.addListener("place_changed", () => {
      const place = autocompleteDestino.getPlace();
      if (!place.geometry || !place.geometry.location) {
        alert("No se encontró el lugar de destino.");
        return;
      }
      if (destino) {
        marcadores.find(m => m.label === "B")?.setMap(null);
        marcadores = marcadores.filter(m => m.label !== "B");
      }
      destino = place.geometry.location;
      const marcadorDestino = new google.maps.Marker({
        position: destino,
        map,
        label: "B",
      });
      marcadores.push(marcadorDestino);
      map.panTo(destino);

      if (origen && destino) {
        calcularRuta(origen, destino);
      }
    });

    // Clic en mapa para definir puntos
    map.addListener("click", (e) => {
      if (!origen) {
        origen = e.latLng;
        const marcadorOrigen = new google.maps.Marker({
          position: origen,
          map,
          label: "A",
        });
        marcadores.push(marcadorOrigen);

        // Actualiza input de origen con coordenadas
        inputOrigen.value = `Lat: ${origen.lat().toFixed(5)}, Lng: ${origen.lng().toFixed(5)}`;

      } else if (!destino) {
        destino = e.latLng;
        const marcadorDestino = new google.maps.Marker({
          position: destino,
          map,
          label: "B",
        });
        marcadores.push(marcadorDestino);

        // Actualiza input de destino con coordenadas
        inputDestino.value = `Lat: ${destino.lat().toFixed(5)}, Lng: ${destino.lng().toFixed(5)}`;

        calcularRuta(origen, destino);
      }
    });

    // Botón Buscar ruta
    document.getElementById("btn-buscar").addEventListener("click", () => {
      // Revisar que haya texto en ambos inputs
      if (!inputOrigen.value.trim() || !inputDestino.value.trim()) {
        alert("Por favor, escribe origen y destino para buscar la ruta.");
        return;
      }

      // Obtener lugar de origen del autocomplete
      const placeOrigen = autocompleteOrigen.getPlace();
      const placeDestino = autocompleteDestino.getPlace();

      if (!placeOrigen || !placeOrigen.geometry || !placeOrigen.geometry.location) {
        alert("Selecciona un lugar válido en el origen.");
        return;
      }
      if (!placeDestino || !placeDestino.geometry || !placeDestino.geometry.location) {
        alert("Selecciona un lugar válido en el destino.");
        return;
      }

      // Limpiar marcadores anteriores de origen y destino
      if (origen) {
        marcadores.find(m => m.label === "A")?.setMap(null);
        marcadores = marcadores.filter(m => m.label !== "A");
      }
      if (destino) {
        marcadores.find(m => m.label === "B")?.setMap(null);
        marcadores = marcadores.filter(m => m.label !== "B");
      }

      origen = placeOrigen.geometry.location;
      destino = placeDestino.geometry.location;

      // Poner marcadores nuevos
      const marcadorOrigen = new google.maps.Marker({
        position: origen,
        map,
        label: "A",
      });
      marcadores.push(marcadorOrigen);

      const marcadorDestino = new google.maps.Marker({
        position: destino,
        map,
        label: "B",
      });
      marcadores.push(marcadorDestino);

      // Centramos mapa
      map.panTo(origen);

      calcularRuta(origen, destino);
    });
  }

  function updateResultado(html) {
    document.getElementById("resultado").innerHTML = html;
  }

  async function calcularRuta(origen, destino) {
    directionsService.route(
      {
        origin: origen,
        destination: destino,
        travelMode: google.maps.TravelMode.DRIVING,
      },
      async (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
          const ruta = result.routes[0];
          const leg = ruta.legs[0];

          const distanciaTexto = leg.distance.text;
          const duracion = leg.duration.text;
          const distanciaKm = parseFloat(distanciaTexto.replace(",", "").replace(" km", ""));

          // Gasolina (simulación)
          const rendimientoKmPorLitro = 12;
          const precioPorLitro = 24;
          const litrosConsumidos = distanciaKm / rendimientoKmPorLitro;
          const gastoGasolina = litrosConsumidos * precioPorLitro;

          // Casetas
          const { gastoCasetas, casetasDetectadas } = await mostrarCasetasRealesEnRuta(ruta);
          const gastoTotal = gastoCasetas + gastoGasolina;

          document.getElementById("resultado").innerHTML = `
            <p>Distancia: ${distanciaKm.toFixed(2)} km</p>
            <p>Duración estimada: ${duracion}</p>
            <p>Gasolina: ${litrosConsumidos.toFixed(2)} L ($${gastoGasolina.toFixed(2)} MXN)</p>
            <p>Casetas detectadas:<br>${casetasDetectadas.length > 0 ? casetasDetectadas.join("<br>") : "Ninguna"}</p>
            <p>Total Casetas: $${gastoCasetas.toFixed(2)} MXN</p>
            <p>Gasto total estimado: $${gastoTotal.toFixed(2)} MXN</p>
          `;

          const instruccionesDiv = document.getElementById("instrucciones");
          instruccionesDiv.innerHTML = "";
          leg.steps.forEach((step, index) => {
            const div = document.createElement("div");
            div.style.marginBottom = "8px";
            div.innerHTML = `${index + 1}. ${step.instructions}`;
            instruccionesDiv.appendChild(div);
          });

        } else {
          alert("No se pudo calcular la ruta: " + status);
        }
      }
    );
  }

  async function mostrarCasetasRealesEnRuta(ruta) {
    const pasos = ruta.legs[0].steps;
    const tolerancia = 0.02;
    let gastoCasetas = 0;
    let casetasDetectadas = [];

    try {
      const respuesta = await fetch("/static/casetas_mexico.json");
      const plazasCobro = await respuesta.json();

      for (const plaza of plazasCobro) {
        let encontrada = false;
        for (const paso of pasos) {
          const path = paso.path;
          for (const puntoRuta of path) {
            const plat = puntoRuta.lat();
            const plng = puntoRuta.lng();

            if (
              Math.abs(plat - plaza.lat) <= tolerancia &&
              Math.abs(plng - plaza.lng) <= tolerancia
            ) {
              const marcador = new google.maps.Marker({
                position: { lat: plaza.lat, lng: plaza.lng },
                map,
                icon: {
                  url: "https://cdn-icons-png.flaticon.com/512/854/854894.png",
                  scaledSize: new google.maps.Size(30, 30),
                },
                title: plaza.nombre + ` ($${plaza.costo} MXN)`,
              });

              marcadores.push(marcador);
              gastoCasetas += plaza.costo;
              casetasDetectadas.push(`${plaza.nombre}: $${plaza.costo}`);
              encontrada = true;
              break;
            }
          }
          if (encontrada) break;
        }
      }

      return { gastoCasetas, casetasDetectadas };
    } catch (error) {
      console.error("Error cargando casetas:", error);
      return { gastoCasetas: 0, casetasDetectadas: [] };
    }
  }

  function limpiarMapa() {
    for (const marcador of marcadores) {
      marcador.setMap(null);
    }
    marcadores = [];

    if (directionsRenderer) {
      directionsRenderer.setDirections({ routes: [] });
    }

    origen = null;
    destino = null;
    updateResultado("Haz clic en el mapa para elegir origen y destino.");
    document.getElementById("instrucciones").innerHTML = "";
    // Limpiar inputs
    document.getElementById("search-origen").value = "";
    document.getElementById("search-destino").value = "";
  }

  // Botones
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btn-clear").onclick = limpiarMapa;
    document.getElementById("btn-close").onclick = () => {
      document.getElementById("infoWindow").style.display = "none";
    };
  });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATseXRXJunPtS9HPA9RtoKSLbHJpRXqR8&libraries=places&callback=initMap" async defer></script>
</body>
</html>
